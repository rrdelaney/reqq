<html>
  <body>
    <div id="root" />
    <script>
      let API = createAPI('http://localhost:3000')
      API.get('/', res => document.getElementById('root').innerHTML = res.date)

      function createAPI (host) {
        return {
          HAR: [],

          reload (name, run) {
            run()

            if (typeof window !== 'undefined') {
              let listener = new EventSource('http://localhost:3333')
              this.HAR.push(listener)

              let restart = () => {
                listener.onerror = null
                listener.onmessage = (res) => {
                  listener.onmessage = null
                  listener.onerror = restart
                  run(res)
                  console.info(`[HAR] reloading ${name}...`)
                }
              }

              listener.onerror = restart
            }
          },

          get (path, cb) {
            this.reload(`GET ${host}${path}`, () =>
              fetch(`${host}${path}`)
                .then((res) => res.json())
                .then((x) => cb(x))
            )
          },

          post (path, body, cb) {
              this.reload(`POST ${host}${path}`, () =>
                fetch(host, { method: 'post', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
                  .then((res) => res.json())
                  .then((x) => cb(x))
              )
          },

          disconnect () {
            this.HAR.forEach((l) => l.close())
          }
        }
      }
    </script>
  </body>
</html>
